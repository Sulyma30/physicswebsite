{% extends "materials/layout.html" %}

{% block title %} Search {% endblock %}

{% block script %}
<script type="text/babel">


    //It creates info about the theme and here we should use url_for and transfer parameters (theme_id and type: theory or exp) so we can open the page with selected theme by clicking on the corresponding button
    class MaterialInfo extends React.Component {
        constructor(props) {
            super(props);
            this.setSelected = this.setSelected.bind(this);
        }
        setSelected(selected_section, selected_theme, e) {
            this.props.setSelected([this.props.selected[0],selected_section, selected_theme]);
        }
        render() {
            if (this.props.stage !== 3) {
                return null;
            }
            const requirements = [];
            
            //Find selected theme to get info
            var theme;
            for (let i = 0; i < Object.keys(themes).length; i++){
                this.props.themes[this.props.sections[this.props.selected[0]][i].title].forEach( element => {
                    if (element.title === this.props.selected[2]) {
                        theme = element;
                    }
                })
            }
            
            //Find all requirements. It is supposed that themes are connected within a supersection (so its sections are used)
            for (let i = 0; i < Object.keys(themes).length; i++){
                this.props.themes[this.props.sections[this.props.selected[0]][i].title].forEach( element => {
                    if (theme.requirements.includes(element.title)) {
                        requirements.push(
                            <a href="#" className="mx-2 " key={element.title} onClick={(e) => this.setSelected(this.props.sections[this.props.selected[0]][i].title, element.title, e)} >{element.title}</a>
                        );
                    }
                });
            }

            return(
                <div className="container-fluid d-flex flex-column pt-4 align-items-center mt-4">
                    <div className="h1 text-center">{theme.title}</div>
                    
                    
                    {requirements.length != 0 ?
                        <div className="row d-flex justify-content-center pt-3 border-top">
                            <div className="font-weight-bold pr-3">Корисно знати: </div><div className="d-inline-block text-truncate">{requirements}</div>
                        </div>
                    : null
                    }
                    <div className="row mt-3">
                        <div className="col-6">
                            <a href={"/materials/" + theme.id + "/problems"} className="btn btn-outline-bg waves-effect text-nowrap">Розв'язувати задачі</a> 
                        </div>
                        <div className="col-6">
                            <a href={"/materials/" + theme.id + "/theory"}  className="btn btn-outline-bg waves-effect text-nowrap">Читати теорію</a> 
                        </div>
                    </div>
                </div>
            );
        }
    }



    class Selector extends React.Component {
        constructor(props) {
            super(props);
            this.setSelected = this.setSelected.bind(this);
        }
        setSelected(stage, new_selected, e) {
            var element = this.props.selected.slice(0, stage);
            element.push(new_selected);
            this.props.setSelected(element);
        }
        render() {
            const list = [];
            const stage = this.props.stage;
            const selected = this.props.selected;
            

            //For supersections
            if (stage === 0) {
                this.props.options.forEach(element => pushListItem(element, this.props, this.setSelected, stage , selected));
            }
            //For sections and themes
            else {
                this.props.options[selected[stage - 1]].forEach(element => pushListItem(element, this.props, this.setSelected, stage , selected));
            }

            function pushListItem(element, props, setSelected, stage, selected){
                const classMain = "text-center waves-effect ";
                const classSelected = ((element.title === selected[stage]) ? " list-group-item-action list-group-item-light black-text active " : "");
                const classActive = (props.active ? "btn-lg py-3 list-group-item-action list-group-item-light black-text " : "btn-sm my-0 py-2 grey-text"); 
                const classDisabled = (props.disabled_materials.includes(element.title) ? " disabled material_disabled" : "");
                list.push(
                    <div key={element.title} className={classMain + classSelected + classSelected + classActive + classDisabled } id={element.title}  onClick={(e) => setSelected(stage, element.title, e)}>
                        {element.title}
                    </div>
                );
            }
            return(
                <div className={'col-4 d-flex flex-column selector-column list-group ' + (this.props.active ? 'active-column px-0 mx-0' : 'px-1 mx-0 mb-3')} >
                    {list}
                </div>
            );
        }
    }

    class SvgStage extends React.Component {
        render() {
            const SvgOld = this.props.selStage > this.props.stage;
            const SvgActual = this.props.selStage === this.props.stage;
            const svg = <svg height="150" width="100"><circle cx="50" cy="100" r="15" fill={ SvgOld ? "grey" : "white" } /></svg>;
            const text = <div className="text-white text-center pb-4 h3">{this.props.text}</div>;
            return(
                <div className="col-4 text-center">
                    { SvgActual ? text : svg }
                </div>
            );
        }
    }

    class SearchHeader extends React.Component {
        render() {
            const selStage = (this.props.selected === undefined ) ? 0 : this.props.selected.length;
            return(
                <div className="container-fluid" id="search-header">
                    <div className="container">
                        <div className="row justify-content-center align-items-end">
                            <SvgStage stage = {0} selStage = {selStage} text="Розділ" />
                            <SvgStage stage = {1} selStage = {selStage} text="Підрозділ" />
                            <SvgStage stage = {2} selStage = {selStage} text="Тема" />
                        </div>
                    </div>
                </div>
            );
        }
    }

    //Main component where we build searcher and, using info about theme_id, we use fetch and get information about theme (the same info we get when open theory or exp of the theme)
    class MaterialSearch extends React.Component {
        constructor(props) {
            super(props);
            this.state = {
                //It is a list - [supersection, section, theme] of stages that were already selected
                selected : []
            };
            this.setSelected = this.setSelected.bind(this);
        }

        setSelected(selected) {
            //Change the state
            this.setState({ selected : selected });
        }

        render() {
            const materials = [this.props.supersections, this.props.sections, this.props.themes];

            const selected = this.state.selected;

            const visible_options = [];

            // Columns that are not active (in white beam)
            for (let i = 0; i < selected.length; i++) {
                visible_options.push(<Selector key={i} stage={i} selected={this.state.selected} options={materials[i]} active={false} setSelected={this.setSelected} disabled_materials={this.props.disabled_materials} />);
            }
            // Active column or content
            if (selected.length !== 3) {
                visible_options.push(<Selector key={selected.length} stage={selected.length} selected={this.state.selected} options={materials[selected.length]} active={true} setSelected={this.setSelected} disabled_materials={this.props.disabled_materials} />);

                // Supported content
                if (selected.length == 0){
                    visible_options.push(
                        <div className="col-6 mx-auto d-flex flex-column justify-content-center align-items-center text-white">
                            <h1 className="text-center border-bottom">Завдання по темам</h1>
                            <div className="pt-3"> Для кожної теми з фізики ми додали практичні та теоретичні завдання, які сортовані за складністю. Основою цих матеріалів можна вважати збірник задач О. Я. Савченко. <br></br><div class="text-center h5 pt-2">Виберіть зліва розділ фізики, який Вас цікавить!</div></div>
                        </div>
                    );
                }
            }
            return(
                <div className="container-fluid px-0 h-100" >
                    <SearchHeader selected={this.state.selected} />
                    <div className={ 'material-selectors ' + (this.state.selected.length === 3 ? 'container-fluid' : 'container-fluid h-100') }>
                        <div className="container h-100">
                            <div className="row h-100">
                                {visible_options}
                            </div>
                        </div>
                    </div>
                    <div className="d-flex align-items-center" id="material-info">
                        <MaterialInfo stage={selected.length} selected={selected} themes={this.props.themes} sections={this.props.sections} setSelected={this.setSelected} />
                    </div>
                </div>
            );
        }
    }

    //Objects we get with API when we first load the page (I used names "Mechanics" and "Kinematics",... like id but it can be switched with id like numbers )
    const supersections = {{supersections_list}}
    const sections = {{sections_list}}
    const themes = {{themes_list}}
    const disabled_materials = {{disabled_materials}}

   
    ReactDOM.render(<MaterialSearch supersections={supersections} sections={sections} themes={themes} disabled_materials={disabled_materials} />, document.getElementById('material-search'));
    
</script>
{% endblock %}

{% block header %}
<div class="container-fluid d-flex justify-content-center px-0" style="position: absolute; z-index: 1;">
        <svg height="150" viewBox="0 0 1920 150" style=" width:100%;" preserveAspectRatio="xMidYMid slice">
            
            <ellipse cx="1000" cy="40" rx="1000" ry="100" class="material-ufo" />
        </svg>
</div>
{% endblock %}

{% block main %}
<div id="material-search">
</div>
{% endblock %}